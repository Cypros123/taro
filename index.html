<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Выбор карт — 3 из 7</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ --bg1:#0e0b0d; --bg2:#1a1215; --gold:#d9b36c; --ink:#f3efe6; --muted:#b9a795; --cardW: 116px; --ratio: 1.6; --gap: 14px; --safeTop: env(safe-area-inset-top); --safeBottom: env(safe-area-inset-bottom); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif; color:var(--ink); background:
      radial-gradient(120% 100% at 50% -10%, rgba(233,200,145,.08), transparent 60%),
      radial-gradient(140% 120% at 50% 0%, var(--bg2), var(--bg1) 60%);
      display:flex; flex-direction:column; min-height:100%; overflow-x:hidden; }
    header{ position:sticky; top:0; z-index:5; padding:calc(10px + var(--safeTop)) 16px 10px; background:linear-gradient(180deg, rgba(0,0,0,.6), rgba(0,0,0,0)); border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter: blur(4px); }
    .title{font-weight:700; font-size:16px; letter-spacing:.2px}
    .subtitle{font-size:12px; color:var(--muted)}
    .wrap{padding:12px 14px calc(12px + var(--safeBottom)); max-width:960px; width:100%; margin:0 auto;}
    .rows{display:flex; flex-direction:column; gap:16px; align-items:center; justify-content:center;}
    .row{ display:flex; gap:var(--gap); justify-content:center; align-items:flex-start; width:100%; flex-wrap:nowrap; }
    .card{ width:var(--cardW); height:calc(var(--cardW) * var(--ratio)); border-radius:14px; position:relative; cursor:pointer; perspective:1000px; flex:0 0 auto; background:none; border:none; padding:0; transition: transform .2s ease; }
    .card-inner{ position:absolute; inset:0; transform-style:preserve-3d; transition: transform 1s ease-in-out, box-shadow .35s ease; border-radius:14px; overflow:hidden; box-shadow:0 10px 22px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04); will-change: transform; background:#1b1013; }
    .card.selected .card-inner{ transform: rotateY(180deg); box-shadow: 0 0 22px rgba(233,200,145,.55), 0 10px 22px rgba(0,0,0,.55); }
    .card.locked{ pointer-events:none; }
    .face,.back{ position:absolute; inset:0; backface-visibility:hidden; border-radius:14px; }
    .back{ background:
      radial-gradient(60% 40% at 30% 20%, rgba(233,200,145,.07), transparent 36%),
      radial-gradient(50% 40% at 70% 80%, rgba(233,200,145,.05), transparent 40%),
      linear-gradient(145deg, #261316, #140b0d); border:1px solid #6d3b3f; display:flex; align-items:center; justify-content:center; }
    .sigil{ width:62%; height:62%; border-radius:50%; border:2px dashed rgba(217,179,108,.55); display:grid; place-items:center; position:relative; }
    .sigil::after{ content:""; position:absolute; inset:12%; border-radius:50%; border:1px solid rgba(217,179,108,.35); }
    .sigil svg{ width:70%; opacity:.9; }
    .face{ transform: rotateY(180deg); background:
      radial-gradient(140% 120% at 50% -10%, rgba(250,220,150,.10), transparent 60%),
      linear-gradient(160deg, #2b181b, #1b1013 70%); border:1px solid rgba(255,255,255,.06); display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
    .art{ width:84%; height:88%; border-radius:12px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 2px 6px rgba(0,0,0,.35); background:#000; display:flex; align-items:center; justify-content:center; }
    .art img{ width:100%; height:100%; object-fit:cover; display:block; }
    .rev-badge{ position:absolute; top:8px; right:8px; font-size:11px; padding:4px 6px; border-radius:8px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.15); color:var(--ink); display:none; }
    .card.rev .rev-badge{ display:block; }
    .contbar{ position:fixed; z-index:50; left:50%; transform:translateX(-50%); display:none; }
    .contbar.show{ display:block; animation: rise .25s ease both; }
    @keyframes rise{ from{ transform: translate(-50%, 6px); opacity:0 } to{ transform: translate(-50%,0); opacity:1 } }
    .contbtn{ padding: 12px 18px; border-radius: 14px; border: 1px solid rgba(255,255,255,.14); font-weight: 700; background: linear-gradient(180deg, rgba(233,200,145,.22), rgba(233,200,145,.10)); color: var(--ink); cursor: pointer; box-shadow: 0 6px 18px rgba(0,0,0,.35); }
    .floating{ position:fixed !important; z-index:40; margin:0 !important; transition: transform 1.5s ease-in-out !important; will-change: transform; }
    .fade-out{ opacity:0; transition: opacity .35s ease; }
  </style>
</head>
<body>
  <header>
    <div class="title">Выберите 3 карты</div>
    <div class="subtitle">Коснитесь карты — она перевернётся и выбор закрепится</div>
  </header>

  <div class="wrap">
    <div class="rows">
      <div class="row" id="rowTop"></div>
      <div class="row" id="rowBottom"></div>
    </div>
  </div>

  <div class="contbar" id="contbar">
    <button class="contbtn" id="btnContinue">Продолжить</button>
  </div>

  <script>
    const tg = window.Telegram?.WebApp; 
    if (tg){ tg.ready(); tg.expand(); tg.setHeaderColor('secondary'); }

    const NAMES_RU = [
      "Шут","Маг","Верховная Жрица","Императрица","Император","Иерофант",
      "Влюблённые","Колесница","Сила","Отшельник","Колесо Фортуны",
      "Справедливость","Повешенный","Смерть","Умеренность","Дьявол",
      "Башня","Звезда","Луна","Солнце","Суд","Мир",
      "Туз Жезлов","2 Жезлов","3 Жезлов","4 Жезлов","5 Жезлов","6 Жезлов",
      "7 Жезлов","8 Жезлов","9 Жезлов","10 Жезлов","Паж Жезлов",
      "Рыцарь Жезлов","Королева Жезлов","Король Жезлов",
      "Туз Кубков","2 Кубков","3 Кубков","4 Кубков","5 Кубков","6 Кубков",
      "7 Кубков","8 Кубков","9 Кубков","10 Кубков","Паж Кубков",
      "Рыцарь Кубков","Королева Кубков","Король Кубков",
      "Туз Мечей","2 Мечей","3 Мечей","4 Мечей","5 Мечей","6 Мечей",
      "7 Мечей","8 Мечей","9 Мечей","10 Мечей","Паж Мечей",
      "Рыцарь Мечей","Королева Мечей","Король Мечей",
      "Туз Пентаклей","2 Пентаклей","3 Пентаклей","4 Пентаклей","5 Пентаклей","6 Пентаклей",
      "7 Пентаклей","8 Пентаклей","9 Пентаклей","10 Пентаклей","Паж Пентаклей",
      "Рыцарь Пентаклей","Королева Пентаклей","Король Пентаклей"
    ];
    const idToName = id => NAMES_RU[id] || `Карта ${id}`;

    const LIMIT = 3, DECK_SIZE = 78;
    const url = new URL(location.href);
    const SEED = url.searchParams.get('seed') || String(Date.now() ^ Math.random()*1e9);
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7, t|61);return((t^t>>>14)>>>0)/4294967296}}
    function seededShuffle(arr, seedStr){
      const seed = Array.from(seedStr).reduce((s,c)=> (s*31 + c.charCodeAt(0))>>>0, 0x811C9DC5);
      const rnd = mulberry32(seed);
      for(let i=arr.length-1;i>0;i--){ const j = Math.floor(rnd()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }
    function faceUrl(id){ return `faces/${id}.png`; }

    function computeCardWidth(){
      const vw = Math.min(window.innerWidth, document.documentElement.clientWidth);
      const vh = Math.min(window.innerHeight, document.documentElement.clientHeight);
      const gap = 14, headerH = 72, bottomPad = 64;
      const maxWByRowTop = (vw - gap*2 - 28) / 3;
      const maxWByRowBot = (vw - gap*3 - 28) / 4;
      const maxWByWidth  = Math.min(maxWByRowTop, maxWByRowBot);
      const availableH   = vh - headerH - bottomPad - 20;
      const maxWByHeight = (availableH - 16) / (2 * 1.6);
      const comfort = 140;
      const cardW = Math.max(92, Math.min(comfort, maxWByWidth, maxWByHeight));
      document.documentElement.style.setProperty('--cardW', cardW + 'px');
    }

    const rowTop = document.getElementById('rowTop');
    const rowBottom = document.getElementById('rowBottom');
    const contbar = document.getElementById('contbar');

    let selected = [], reversed = [];
    let idsTop = [], idsBottom = [];
    const seedNum = Array.from(SEED).reduce((s,c)=> (s*31 + c.charCodeAt(0))>>>0, 0x811C9DC5);
    const rnd = mulberry32(seedNum);

    function dealCards(){
      const deck = seededShuffle([...Array(DECK_SIZE).keys()], SEED).slice(0,7);
      idsTop = deck.slice(0,3);
      idsBottom = deck.slice(3,7);
    }

    function preloadFaces(ids){ ids.forEach(id=>{ const img=new Image(); img.src = faceUrl(id); }); }

    function makeCard(id){
      const card = document.createElement('button');
      card.className = 'card';
      card.type = 'button';
      card.dataset.id = String(id);
      card.setAttribute('aria-label','Выбрать карту');

      const inner = document.createElement('div'); inner.className = 'card-inner';
      const back = document.createElement('div'); back.className = 'back';
      back.innerHTML = `<div class='sigil'><svg viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'><circle cx='50' cy='50' r='30' stroke='#d9b36c' stroke-width='3' /><path d='M50 22 L54 46 L78 50 L54 54 L50 78 L46 54 L22 50 L46 46 Z' stroke='#e9c891' stroke-width='2'/></svg></div>`;
      const face = document.createElement('div'); face.className = 'face';
      const art = document.createElement('div'); art.className = 'art';
      const img = document.createElement('img'); img.src = faceUrl(id); img.alt = idToName(id);
      const badge = document.createElement('div'); badge.className='rev-badge'; badge.textContent='перевёрнута';
      art.appendChild(img); face.appendChild(art); face.appendChild(badge);

      inner.appendChild(back); inner.appendChild(face);
      card.appendChild(inner);
      card.addEventListener('click', () => select(card, id));
      return card;
    }

    function build(){
      dealCards(); computeCardWidth();
      idsTop.forEach(id=> rowTop.appendChild(makeCard(id)));
      idsBottom.forEach(id=> rowBottom.appendChild(makeCard(id)));
      preloadFaces([...idsTop, ...idsBottom]);
      window.addEventListener('resize', computeCardWidth, {passive:true});
      window.addEventListener('orientationchange', ()=>setTimeout(computeCardWidth, 120));
    }

    function select(card, id){
      if (selected.length >= 3 || card.classList.contains('locked')) return;
      const isRev = rnd() < 0.5;
      reversed.push(isRev);
      if (isRev) {
        card.classList.add('rev');
        card.querySelector('.face .art img').style.transform = 'rotate(180deg)';
      }
      card.classList.add('selected','locked'); selected.push(id);
      if (selected.length === 3) moveToCenter();
    }

    function moveToCenter(){
      document.querySelectorAll('.card').forEach(el=>{
        const id = Number(el.dataset.id);
        if (!selected.includes(id)){ el.classList.add('fade-out'); el.style.pointerEvents = 'none'; }
      });
      const gap = 16;
      const cardW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardW'));
      const targetW = Math.min(150, Math.max(100, cardW + 6));
      const targetH = targetW * 1.6;
      const totalW  = targetW*3 + gap*2;
      const startX  = (window.innerWidth - totalW)/2;
      const y       = (window.innerHeight - targetH)/2 + 6;
      const contTop = y + targetH + 12;
      contbar.style.top = contTop + 'px';
      contbar.classList.add('show');
      // MainButton for Telegram
      tg?.MainButton?.setText?.('Продолжить'); tg?.MainButton?.show?.();
      tg?.onEvent?.('mainButtonClicked', submit);
    }

    function getPayload(){
      const ids = selected.slice(0,3);
      return { type:'tarot_selection', seed: SEED, cards: ids, names: ids.map(idToName), rev: reversed.slice(0,3) };
    }
    function submit(){
      const payload = getPayload();
      if (tg){ tg.sendData(JSON.stringify(payload)); tg.close(); } else { alert(JSON.stringify(payload)); }
    }
    document.getElementById('btnContinue').addEventListener('click', submit);
    build();
  </script>
</body>
</html>